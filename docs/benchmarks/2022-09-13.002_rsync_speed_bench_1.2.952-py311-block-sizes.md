# Простые тесты скорости работы DedupSQLfs v1.2.952 за 02.05.2022

Проверка работы блоков разных размеров на больших данных.
Плюс - исправленная версия модуля zstd, обновленная - lz4.
Установка размера page_size для таблицы блоков данных.

Cинхронизация Qt 5.12.12, 5.15.6, 6.3.2 с помощью rsync.

Проверка работы на движке: sqlite 3.39.3

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe

System: Ubuntu 18.04 amd64

Kernel: 5.4.0-125-lowlatency

Python: 3.11.0rc2

Размер Qt в tar:

* 5.12.12 - 2825M
* 5.15.6 - 3616M
* 6.3.2 - 3775M

Другое: включен autocommit, выключен sync, hash=md5

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --data $HOME/Temp/sqlfs/data/ \
 --compress lz4 \
 --block-size {size} \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu single \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt. Тестировалась в том числе и дедупликация.

Для python3.11 нет модуля recordclass.

Тестировались только методы:

* none
* zstd(:1)
* brotli(:0)
* lz4

Тестировались размеры блоков (--block-size): 1k, 4k, 8k, 16k, 32k, 64k, 128k(default), 256k, 512k, 1024k

## Тесты

| Qt ver   |           | 5.12.12                                                ||||| 5.15.6                                                 ||||| 6.3.2                                                  |||||
|----------|:---------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 11:55.00 | 315        | 5.12       | 3.45       | 3081     | 12:20.68 | 423        | 7.68       | 2.87       | 5689     | 13:27.17 | 466        | 7.40      | 2.69       | 8379     |
| single   |   4k      |   | 290        | 13.40      | 6.33       | 2679     | 6:47.20  | 404        | 15.66      | 5.22       | 4964     | 7:05.35  | 439        | 16.57      | 5.11       | 7351     |
| none     |   8k      | :55.02  | 253        | 18.56      | 7.02       | 2529     | 5:56.67  | 406        | 22.23      | 5.89       | 4721     | 6:33.41  | 463        | 23.78      | 5.51       | 7018     |
|          |  16k      | :20.81  | 263        | 21.71      | 7.66       | 2460     | 5:16.88  | 388        | 27.60      | 6.53       | 4620     | 5:45.42  | 448        | 29.34      | 6.24       | 6913     |
|          |  32k      | :20.50  | 264        | 22.15      | 7.69       | 2430     | 5:32.13  | 389        | 26.98      | 6.17       | 4600     | 6:15.19  | 398        | 28.00      | 5.72       | 6912     |
|          |  64k      | :12.71  | 257        | 23.21      | 7.86       | 2418     | 5:27.70  | 363        | 30.15      | 6.23       | 4591     | 6:07.70  | 413        | 32.32      | 5.85       | 6939     |
|          | 128k      | :31.38  | 257        | 22.68      | 7.43       | 2415     | 5:03.59  | 422        | 33.75      | 6.69       | 4601     | 6:23.24  | 407        | 33.31      | 5.59       | 6988     |
|          | 256k      | :19.78  | 264        | 23.97      | 7.71       | 2417     | 5:57.18  | 377        | 31.48      | 5.69       | 4604     | 5:56.41  | 447        | 36.13      | 6.03       | 6991     |
|          | 512k      | :10.13  | 260        | 23.09      | 7.91       | 2418     | 5:10.51  | 429        | 33.24      | 6.58       | 4614     | 5:48.11  | 428        | 36.07      | 6.15       | 7040     |
|          | 1024k     | :08.35  | 172        | 24.48      | 7.99       | 2418     | 5:35.82  | 369        | 31.55      | 6.04       | 4629     | 5:30.74  | 420        | 38.04      | 6.47       | 7071     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | :29.82  | 223        | 12.97      | 6.33       | 1596     | 6:45.08  | 326        | 17.24      | 5.16       | 2888     | 6:58.44  | 409        | 16.99      | 5.18       | 4182     |
| single   |   4k      | :29.82  | 223        | 12.97      | 6.33       | 1596     | 6:45.08  | 326        | 17.24      | 5.16       | 2888     | 6:58.44  | 409        | 16.99      | 5.18       | 4182     |
| lz4      |   8k      | :14.87  | 185        | 16.67      | 6.68       | 1420     | 6:25.13  | 329        | 18.94      | 5.39       | 2568     | 6:42.77  | 357        | 24.86      | 5.34       | 3728     |
|          |  16k      | :40.39  | 175        | 19.69      | 7.25       | 1274     | 5:21.05  | 340        | 27.84      | 6.43       | 2305     | 6:00.84  | 340        | 25.82      | 5.98       | 3329     |
|          |  32k      | :14.84  | 172        | 21.73      | 7.79       | 1209     | 5:12.77  | 319        | 29.21      | 6.55       | 2181     | 5:52.37  | 250        | 32.37      | 6.13       | 3162     |
|          |  64k      | :17.14  | 171        | 24.22      | 7.79       | 1176     | 5:08.42  | 260        | 31.52      | 6.64       | 2135     | 5:34.60  | 253        | 33.94      | 6.44       | 3096     |
|          | 128k      | :03.85  | 178        | 25.67      | 8.10       | 1162     | 5:07.88  | 251        | 32.72      | 6.62       | 2095     | 5:39.03  | 254        | 33.84      | 6.33       | 3053     |
|          | 256k      | :45.55  | 158        | 21.36      | 7.10       | 1157     | 5:32.51  | 241        | 32.09      | 6.10       | 2087     | 5:49.64  | 254        | 33.72      | 6.11       | 3048     |
|          | 512k      | :24.52  | 160        | 23.09      | 7.59       | 1156     | 5:11.43  | 258        | 35.83      | 6.53       | 2110     | 5:34.47  | 263        | 36.31      | 6.45       | 3056     |
|          | 1024k     | :29.28  | 168        | 23.64      | 7.50       | 1155     | 5:17.19  | 240        | 33.68      | 6.41       | 2089     | 5:29.65  | 267        | 37.09      | 6.51       | 3053     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | :04.04  | 209        | 11.71      | 5.79       | 1182     | 7:08.63  | 286        | 14.79      | 4.87       | 2069     | 8:52.62  | 268        | 15.47      | 4.06       | 2948     |
| single   |   4k      | :04.04  | 209        | 11.71      | 5.79       | 1182     | 7:08.63  | 286        | 14.79      | 4.87       | 2069     | 8:52.62  | 268        | 15.47      | 4.06       | 2948     |
| zstd:1   |   8k      | :55.16  | 171        | 14.17      | 5.91       | 1126     | 7:04.76  | 242        | 17.95      | 4.88       | 2002     | 7:29.87  | 253        | 19.66      | 4.78       | 2887     |
|          |  16k      | :21.37  | 165        | 17.42      | 6.48       | 1008     | 6:10.03  | 236        | 24.54      | 5.57       | 1771     | 6:45.55  | 259        | 22.83      | 5.33       | 2533     |
|          |  32k      | :03.59  | 165        | 18.30      | 6.77       | 972      | 6:03.49  | 241        | 26.98      | 5.80       | 1668     | 6:28.88  | 232        | 25.84      | 5.51       | 2391     |
|          |  64k      | :06.67  | 147        | 20.30      | 6.69       | 944      | 5:38.83  | 224        | 28.80      | 6.01       | 1622     | 6:03.44  | 250        | 28.97      | 5.93       | 2319     |
|          | 128k      | :45.45  | 164        | 22.15      | 7.10       | 930      | 5:20.29  | 255        | 31.11      | 6.35       | 1587     | 6:03.64  | 256        | 29.88      | 5.93       | 2277     |
|          | 256k      |   | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 512k      | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 1024k     | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | :04.04  | 209        | 11.71      | 5.79       | 1182     | 7:08.63  | 286        | 14.79      | 4.87       | 2069     | 8:52.62  | 268        | 15.47      | 4.06       | 2948     |
| single   |   4k      | :04.04  | 209        | 11.71      | 5.79       | 1182     | 7:08.63  | 286        | 14.79      | 4.87       | 2069     | 8:52.62  | 268        | 15.47      | 4.06       | 2948     |
| brotli:0 |   8k      | :55.16  | 171        | 14.17      | 5.91       | 1126     | 7:04.76  | 242        | 17.95      | 4.88       | 2002     | 7:29.87  | 253        | 19.66      | 4.78       | 2887     |
|          |  16k      | :21.37  | 165        | 17.42      | 6.48       | 1008     | 6:10.03  | 236        | 24.54      | 5.57       | 1771     | 6:45.55  | 259        | 22.83      | 5.33       | 2533     |
|          |  32k      | :03.59  | 165        | 18.30      | 6.77       | 972      | 6:03.49  | 241        | 26.98      | 5.80       | 1668     | 6:28.88  | 232        | 25.84      | 5.51       | 2391     |
|          |  64k      | :06.67  | 147        | 20.30      | 6.69       | 944      | 5:38.83  | 224        | 28.80      | 6.01       | 1622     | 6:03.44  | 250        | 28.97      | 5.93       | 2319     |
|          | 128k      | :45.45  | 164        | 22.15      | 7.10       | 930      | 5:20.29  | 255        | 31.11      | 6.35       | 1587     | 6:03.64  | 256        | 29.88      | 5.93       | 2277     |
|          | 256k      |   | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 512k      | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 1024k     | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |

* :time   - время работы dedupsqlfs, в том числе и umount
* :memory - размер в памяти, согласно отладке в time, max resident size MiB
* :speedD - показатели отладки dedupsqlfs по скорости потоковой записи данных, MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB

## Результат

Просто посмотреть и сравнить скорость работы с разным размером блоков. И сколько памяти тратится.

- размер блока по-умолчанию лучше сделать 64kb
