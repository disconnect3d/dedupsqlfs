# Простые тесты скорости работы DedupSQLfs v1.2.952 за 02.05.2022

Проверка работы блоков разных размеров на больших данных.
Плюс - исправленная версия модуля zstd, обновленная - lz4.
Установка размера page_size для таблицы блоков данных.

Cинхронизация Qt 5.12.12, 5.15.6, 6.3.2 с помощью rsync.

Проверка работы на движке: sqlite 3.39.3

- CPU: i5-6600K @ 3.50GHz
- DISK: 500Gb SSD NVMe

System: Ubuntu 18.04 amd64

Kernel: 5.4.0-125-lowlatency

Python: 3.11.0rc2

Размер Qt в tar:

* 5.12.12 - 2825M
* 5.15.6 - 3616M
* 6.3.2 - 3775M

Другое: включен autocommit, выключен sync, hash=md5

Команда:
```sh
/usr/bin/time -v python3.11 ./mount.dedupsqlfs -vv --verbose-stats --data $HOME/Temp/sqlfs/data/ \
 --compress lz4 \
 --block-size {size} \
 --no-sync --no-cache-flusher --minimal-compress-size -1 \
 --multi-cpu single \
 -o noatime $HOME/Temp/sqlfs/mount
```

Синхронизация Qt:
```sh
rsync -aHh --stats --delete --sparse --inplace --no-whole-file {qt-dir}/ $HOME/Temp/sqlfs/mount/Qt/ && sudo umount $HOME/Temp/sqlfs/mount
```

Синхронизация происходила поверх предыдущих копий Qt. Тестировалась в том числе и дедупликация.

Для python3.11 нет модуля recordclass.

Тестировались только методы:

* none
* zstd(:1)
* brotli(:0)
* lz4

Тестировались размеры блоков (--block-size): 1k, 4k, 8k, 16k, 32k, 64k, 128k(default), 256k, 512k, 1024k

## Тесты

| Qt ver   |           | 5.12.12                                                ||||| 5.15.6                                                 ||||| 6.3.2                                                  |||||
|----------|:---------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|:--------:|:----------:|:----------:|:----------:|:--------:|
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 11:55.00 | 315        | 5.12       | 3.45       | 3081     | 12:20.68 | 423        | 7.68       | 2.87       | 5689     | 13:27.17 | 466        | 7.40      | 2.69       | 8379     |
| single   |   4k      | 6:52.50  | 247        | 12.96      | 5.96       | 2679     | 7:17.38  | 315        | 16.55      | 4.84       | 4963     | 7:20.06  | 335        | 18.52     | 4.93       | 7350     |
| none     |   8k      | 6:18.62  | 203        | 16.67      | 6.55       | 2529     | 6:00.58  | 282        | 22.23      | 5.77       | 4721     | 6:25.67  | 288        | 21.36     | 5.59       | 7023     |
|          |  16k      | 5:26.97  | 184        | 21.05      | 7.52       | 2460     | 5:15.38  | 287        | 27.83      | 6.53       | 4621     | 5:38.93  | 271        | 28.97     | 6.36       | 6915     |
|          |  32k      | 5:30.43  | 172        | 22.11      | 7.43       | 2430     | 5:24.94  | 245        | 29.06      | 6.28       | 4601     | 5:42.93  | 260        | 31.32     | 6.27       | 6920     |
|          |  64k      | 5:53.19  | 160        | 21.96      | 6.96       | 2418     | 4:57.86  | 258        | 33.06      | 6.85       | 4595     | 5:42.97  | 252        | 35.32     | 6.28       | 6947     |
|          | 128k      | 5:20.34  | 167        | 23.75      | 7.71       | 2415     | 5:21.92  | 225        | 33.54      | 6.33       | 4597     | 5:25.70  | 267        | 37.99     | 6.57       | 6977     |
|          | 256k      | 5:03.89  | 167        | 26.36      | 8.10       | 2417     | 4:52.14  | 255        | 35.14      | 6.94       | 4603     | 6:06.92  | 259        | 33.84     | 5.83       | 7010     |
|          | 512k      | 5:17.73  | 168        | 22.79      | 7.76       | 2418     | 5:22.47  | 244        | 37.10      | 6.31       | 4619     | 6:09.36  | 240        | 37.03     | 5.80       | 7015     |
|          | 1024k     | 5:10.56  | 168        | 24.88      | 7.91       | 2418     | 5:18.10  | 242        | 31.69      | 6.39       | 4628     | 5:54.91  | 260        | 33.56     | 6.05       | 7065     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 10:59.35 | 327        | 5.22       | 3.74       | 1830     | 12:03.71 | 392        | 6.55      | 2.95       | 3273     | 12:56.85  | 424        | 7.83      | 2.80       | 4709     |
| single   |   4k      | 7:02.80  | 229        | 12.40      | 5.80       | 1596     | 7:00.53  | 328        | 17.39     | 4.97       | 2889     | 7:24.72  | 328        | 15.97      | 4.87       | 4183     |
| lz4      |   8k      | 5:51.31  | 202        | 17.95      | 7.00       | 1420     | 5:33.16  | 298        | 23.07      | 6.26       | 2568     | 6:18.95  | 299        | 21.80      | 5.69       | 3728     |
|          |  16k      | 5:48.84  | 179        | 19.97      | 7.06       | 1274     | 5:53.32  | 249        | 25.96      | 5.83       | 2305     | 6:26.04  | 264        | 25.80      | 5.58       | 3338     |
|          |  32k      | 5:22.80  | 174        | 22.74      | 7.62       | 1209     | 5:27.86  | 244        | 30.50      | 6.25       | 2173     | 5:32.56  | 269        | 31.29      | 6.48       | 3155     |
|          |  64k      | 5:46.52  | 155        | 22.31      | 7.06       | 1176     | 5:34.24  | 247        | 30.51      | 6.14       | 2120     | 5:54.42  | 249        | 31.44      | 6.10       | 3072     |
|          | 128k      | 5:25.82  | 163        | 22.16      | 7.52       | 1162     | 5:09.73  | 231        | 32.52      | 6.53       | 2099     | 5:54.72  | 254        | 34.42      | 6.05       | 3051     |
|          | 256k      | 5:21.87  | 163        | 23.37      | 7.62       | 1157     | 5:08.05  | 235        | 33.31      | 6.60       | 2104     | 5:54.59  | 249        | 36.31      | 6.05       | 3062     |
|          | 512k      | 5:21.56  | 166        | 24.48      | 7.64       | 1156     | 5:50.64  | 237        | 32.38      | 5.78       | 2084     | 5:39.47  | 237        | 37.08      | 6.33       | 3030     |
|          | 1024k     | 5:17.23  | 172        | 23.85      | 7.76       | 1155     | 5:16.12  | 227        | 33.68      | 6.43       | 2090     | 5:24.70  | 268        | 34.29      | 6.61       | 3058     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | 11:50.34 | 324        | 5.42       | 3.46       | 1538     | 13:35.29  | 330        | 7.32      | 2.61       | 2705     | 14:28.66  | 370        | 7.13      | 2.49       | 3871     |
| single   |   4k      | 7:22.44  | 219        | 11.57      | 5.56       | 1199     | 7:10.83  | 312        | 15.82      | 4.85       | 2102     | 7:28.88  | 318        | 15.96      | 4.80       | 3000     |
| zstd:1   |   8k      | 5:57.56  | 206        | 15.93      | 6.86       | 1143     | 6:16.90  | 290        | 19.18      | 5.51       | 2038     | 6:34.24  | 306        | 21.24      | 5.47       | 2944     |
|          |  16k      | 5:28.85  | 190        | 20.14      | 7.45       | 1023     | 6:42.20  | 235        | 23.99      | 5.14       | 1803     | 6:35.08  | 254        | 28.59      | 5.45       | 2585     |
|          |  32k      | 6:02.50  | 171        | 20.05      | 6.79       | 990      | 7:06.11  | 236        | 24.39      | 4.79       | 1707     | 6:55.66  | 228        | 29.38      | 5.16       | 2451     |
|          |  64k      | 6:02.19  | 160        | 21.97      | 7.06       | 963      | 6:06.29  | 243        | 28.12      | 5.57       | 1663     | 6:33.70  | 242        | 26.98      | 5.45       | 2379     |
|          | 128k      | 5:41.17  | 161        | 21.36      | 7.19       | 950      | 5:27.48  | 245        | 31.44      | 6.19       | 1633     | 6:06.02  | 244        | 33.20      | 5.85       | 2349     |
|          | 256k      |   | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 512k      | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 1024k     | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
| **Mode** | **block** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** | **time** | **memory** | **speedD** | **speedR** | **size** |
|          |   1k      | :04.04  | 209        | 11.71      | 5.79       | 1182     | 7:08.63  | 286        | 14.79      | 4.87       | 2069     | 8:52.62  | 268        | 15.47      | 4.06       | 2948     |
| single   |   4k      | :04.04  | 209        | 11.71      | 5.79       | 1182     | 7:08.63  | 286        | 14.79      | 4.87       | 2069     | 8:52.62  | 268        | 15.47      | 4.06       | 2948     |
| brotli:0 |   8k      | :55.16  | 171        | 14.17      | 5.91       | 1126     | 7:04.76  | 242        | 17.95      | 4.88       | 2002     | 7:29.87  | 253        | 19.66      | 4.78       | 2887     |
|          |  16k      | :21.37  | 165        | 17.42      | 6.48       | 1008     | 6:10.03  | 236        | 24.54      | 5.57       | 1771     | 6:45.55  | 259        | 22.83      | 5.33       | 2533     |
|          |  32k      | :03.59  | 165        | 18.30      | 6.77       | 972      | 6:03.49  | 241        | 26.98      | 5.80       | 1668     | 6:28.88  | 232        | 25.84      | 5.51       | 2391     |
|          |  64k      | :06.67  | 147        | 20.30      | 6.69       | 944      | 5:38.83  | 224        | 28.80      | 6.01       | 1622     | 6:03.44  | 250        | 28.97      | 5.93       | 2319     |
|          | 128k      | :45.45  | 164        | 22.15      | 7.10       | 930      | 5:20.29  | 255        | 31.11      | 6.35       | 1587     | 6:03.64  | 256        | 29.88      | 5.93       | 2277     |
|          | 256k      |   | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 512k      | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |
|          | 1024k     | :57.40  | 228        | 15.16      | 5.91       | 927      | 6:57.40  | 228        | 15.16      | 5.91       | 927      | 8:15.96  | 276        | 18.68      | 5.60       | 1805     |

* :time   - время работы dedupsqlfs, в том числе и umount
* :memory - размер в памяти, согласно отладке в time, max resident size MiB
* :speedD - показатели отладки dedupsqlfs по скорости потоковой записи данных, MiB/s
* :speedR - показатели rsync по скорости записи данных, MiB/s
* :size   - размер итоговых данных в ~/Temp/sqlfs/data/, MiB

## Результат

Просто посмотреть и сравнить скорость работы с разным размером блоков. И сколько памяти тратится.
